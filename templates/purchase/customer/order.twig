{% extends 'purchase/_layouts/main' %}
{% import '_incl/docMacros' as macro %}

{% set number = craft.app.request.param('number') %}
{% set env = getenv('ENVIRONMENT') %}

{% if not number %}
    {% redirect 'shop/customer' %}
{% endif %}

{% set order = craft.orders.number(number).one() %}

{% if not order or order.isCompleted == false %}
    {% redirect 'shop/customer' %}
{% endif %}

{%- set goalTracker -%}
	{% if env == 'production' %}
        <script>
            window.addEventListener('load', (event) => {
                fathom.trackGoal('5B3EYCZK', {{ order.totalPrice * 100 }});
            });
        </script>
	{% endif %}
{%- endset -%}

{% block main %}
    <div class="orderHead">
        <h1>{{'Bestellung'|t}}: #{{ order.reference }}</h1>
        {% if currentUser %}
            <p class="customerLink">
                <a href="{{ url('purchase/customer') }}">{{'Meine Bestellungen'|t}}</a>
            </p>
        {% endif %}
    </div>

    <div class="md:flex">
        <div class="md:w-4/5 orderMessage">
            <div class="orderSuccessMessage">
                {{ macro.richText(checkoutFields.orderSuccessMessage) }}
            </div>
            <div class="orderShipmentProvider">{{ macro.richText(checkoutFields.orderShipmentProvider) }}</div>
        </div>
        <div class="md:flex md:w-4/5 flex-col">
            <div class="flex-initial md:m-2 panel">
                <h3>{{'Bestelldetails'|t}}</h3>

                <ul class="list-reset order-details">
                    <li><strong>{{ "E-Mail"|t }}:</strong> <a href="mailto:{{ order.email }}">{{ order.email }}</a></li>
                    <li><strong>{{ "Total"|t }}:</strong> {{ order.totalPrice|commerceCurrency(order.currency) }}</li>
                    <li><strong>{{ "Bestelldatum"|t }}:</strong> {{macro.defDate(order.dateOrdered)}}</li>
                    <li><strong>{{ 'Zahlart' | t }}:</strong> {{ order.gateway }}</li>
                    {% if order.pdfUrl %}
                        <li><strong>{{'Quittung'|t}}:</strong> <a href="{{ order.getPdfUrl('receipt') }}" class="customerLink">Download</a></li>
                    {% endif %}
                </ul>
            </div>
            <div class="md:flex">
                <div class="md:m-2 panel">
                    <h4>{{'Lieferadresse'|t}}</h4>
                    {% if order.shippingAddress %}
                        {% include 'purchase/_includes/addresses/address' with { address: order.shippingAddress } %}
                    {% endif %}
                </div>
                <div class="md:m-2 panel">
                    <h4>{{'Rechnungsadresse'|t}}</h4>
                    {% if order.billingAddress %}
                        {% include 'purchase/_includes/addresses/address' with { address: order.billingAddress } %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <h3>{{'Bestelliste'|t}}</h3>
    <div class="order panel">
        <div class="tableRow tableHead">
            <div>{{ "Produkt" | t }}</div>
            <div></div>
            <div>{{ "Menge" | t }}</div>
            <div class="text-right">{{ "Preis" | t }}</div>
        </div>
        <div class="orderGrid">
            {% for item in order.lineItems %}
                <div class="tableRow itemRow">
                    <p>
                        <strong>{{ item.description }}</strong><br>
                        SKU: {{ item.sku }}
                    </p>
                    {% set cartThumb = item.purchasable.variantThumb.one() %}
                    {{ macro.checkoutThumb(cartThumb) }}   
                    <p> <strong {% if item.qty > 1 %}class="multipleUnits"{% endif %}>{{ item.qty }}</strong> Ex. Ã  {{ item.price|commerceCurrency(order.currency) }}</p>
                    <div class="md:text-right">
                        {% if item.onSale %}
                            <strike>{{ item.price|commerceCurrency(order.currency) }}</strike>   {{ item.salePrice|commerceCurrency(order.currency) }}
                        {% else %}
                            {{ item.subtotal|commerceCurrency(order.currency) }}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}

            {% for adjustment in order.adjustments %}
                <div class="tableRow itemRow">
                    <div><strong>{{ adjustment.type | capitalize }}</strong></div>
                    <div class="adjustmentName">
                        {{ adjustment.name }}
                        {% if adjustment.description %}<br>({{ adjustment.description }}){% endif %}
                    </div>
                    <div>{{ adjustment.amount|commerceCurrency(order.currency) }}</div>
                </div>
            {% endfor %}
        
            <div class="tableRow itemRow">
                <div>
                    <strong>{{'Versandkosten:'|t}}</strong>
                    {% if order.shippingMethod %}
                        {{ order.shippingMethod.name }}
                    {% else %}
                        No shipping method selected.
                    {% endif %}
                </div>
            </div>

            <div class="tableRow itemRow">
                <div></div>
                <div></div>
                <div></div>
                <div class="md:text-right">
                    {% include "purchase/_includes/paidStatus" %}
                    {{'Subtotal'}}: {{ order.itemTotal|commerceCurrency(order.currency) }}<br>
                    <h4>Total: {{ order.totalPrice|commerceCurrency(order.currency) }}</h4>
                </div>
            </div>

        </div>
    </div>
    {% include "_atoms/shopBuyersTrustLinks" %}
    {{ goalTracker }}
{% endblock %}
